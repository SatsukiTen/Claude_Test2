# ブロック崩し (Block Breaker) — 要件仕様書

> **目的**: 本ドキュメントをAIにinputすることで、同等のAndroidアプリを再現できることを目指す。
> **対象読者**: 実装を担当する開発者・AI

---

## 1. アプリ概要

| 項目 | 内容 |
|---|---|
| アプリ名 | Block Breaker |
| パッケージ名 | `com.example.blockbreaker` |
| ジャンル | ブロック崩し（アーケード） |
| プラットフォーム | Android |
| 最小SDKバージョン | API 24 (Android 7.0) |
| ターゲットSDK | API 34 |
| 言語 | Kotlin |
| 画面向き | 縦固定 (Portrait) |
| バージョン | 1.0 |

---

## 2. 機能要件

### 2.1 ゲームプレイ

- ボールをパドルで跳ね返し、全ブロックを破壊するとステージクリア
- ボールが画面下端を超えるとライフ-1
- ライフが0になるとゲームオーバー
- 全10ステージ。ステージ10クリアでオールクリア
- スコアはブロック破壊時に加算（連鎖倍率あり）

### 2.2 ステージ選択

- ゲーム起動時またはゲームオーバー/WIN後にステージ選択画面を表示
- ステージ1〜10を自由に選択して開始できる
- 各ボタンにステージ番号とブロック数を表示
- 難易度を色で示す（緑: 易, 黄: 中, 赤: 難）

### 2.3 ポーズ機能

- ゲームプレイ中（WAITING / PLAYING状態）に右上のポーズボタン（⏸）をタップすると一時停止
- ポーズ画面から「RESUME」「DEBUG SETTINGS」「STAGE SELECT」を選択できる

### 2.4 デバッグ設定

- ポーズ画面の「DEBUG SETTINGS」から設定画面（`SettingsActivity`）を起動
- ゲームの4つの調整パラメータをSeekBarで変更できる
- 設定はSharedPreferencesで永続化され、次回起動時も維持される
- 「デフォルトに戻す」ボタンで初期値にリセット可能

### 2.5 サウンド

- BGM: 手続き生成によるYo音階（ニ長調五音音階）のループメロディ
- SE: 壁/パドル/ブロック衝突、ライフロスト、ゲームオーバー、クリア（全て手続き生成）
- 外部音声ファイル（assets）は使用しない

---

## 3. 非機能要件

| 項目 | 要件 |
|---|---|
| フレームレート | 60 FPS（ゲームループ固定） |
| 描画方式 | `SurfaceView` + Canvasによる直接描画（AndroidビューシステムのXMLレイアウトは設定画面のみ使用） |
| サウンド生成 | 起動時バックグラウンドスレッドでPCM合成 → `SoundPool` / `AudioTrack` に書き込み |
| 設定永続化 | `SharedPreferences` |
| 外部ライブラリ | `androidx.appcompat:appcompat:1.6.1` / `androidx.core:core-ktx:1.12.0` のみ |
| 権限 | 追加パーミッション不要 |

---

## 4. 画面一覧

| 画面ID | 名称 | 種別 |
|---|---|---|
| SCR-01 | ステージ選択画面 | Canvas描画 (GameView) |
| SCR-02 | ゲームプレイ画面 | Canvas描画 (GameView) |
| SCR-03 | ポーズ画面 | Canvas描画オーバーレイ (GameView) |
| SCR-04 | ステージクリア画面 | Canvas描画オーバーレイ (GameView) |
| SCR-05 | ゲームオーバー画面 | Canvas描画オーバーレイ (GameView) |
| SCR-06 | オールクリア画面 | Canvas描画オーバーレイ (GameView) |
| SCR-07 | デバッグ設定画面 | Android XML Layout (SettingsActivity) |

---

## 5. 画面遷移仕様

```
[アプリ起動]
      │
      ▼
[SCR-01: ステージ選択]
      │ ステージボタンタップ
      ▼
[SCR-02: ゲームプレイ (WAITING)]
      │ ドラッグ or タップ
      ▼
[SCR-02: ゲームプレイ (PLAYING)]
      │
      ├─ ⏸ タップ ──────────► [SCR-03: ポーズ]
      │                              │ ▶ RESUME
      │                              │──────────► [SCR-02: WAITING に戻る]
      │                              │ ⚙ DEBUG SETTINGS
      │                              │──────────► [SCR-07: デバッグ設定]
      │                              │                  │ 戻る
      │                              │◄─────────────────┘
      │                              │ ↩ STAGE SELECT
      │                              │──────────► [SCR-01]
      │
      ├─ 全ブロック破壊 (stage < 10) ► [SCR-04: ステージクリア]
      │                              │ タップ
      │                              └──► [SCR-02: 次ステージ WAITING]
      │
      ├─ 全ブロック破壊 (stage = 10) ► [SCR-06: オールクリア]
      │                              │ タップ
      │                              └──► [SCR-01]
      │
      └─ ライフ = 0 ──────────────► [SCR-05: ゲームオーバー]
                                    │ タップ
                                    └──► [SCR-01]
```

---

## 6. 各画面の詳細仕様

### 6.1 SCR-01: ステージ選択画面

**背景**: 黒 (`#000000`)

**要素**:
- タイトルテキスト「SELECT STAGE」: 縦 18% 位置、中央揃え、フォントサイズ screenH × 0.06
- ステージボタン × 10: 2列5行グリッド
  - 各ボタンサイズ: 幅 screenW × 0.42、高さ screenH × 0.075
  - 列間隔 screenW × 0.06、行間隔 screenH × 0.018
  - グリッド開始Y: screenH × 0.28
  - ボタンカラー: ステージ1-3=緑(30,90,50)、4-6=黄(80,70,20)、7-10=赤(90,30,30)
  - ラベル: `Stage N  (X blocks)` 形式、フォントサイズ screenH × 0.034
  - 角丸半径 18f

**操作**:
- ステージボタンをタップ → `score=0, lives=3` にリセットして該当ステージ開始

---

### 6.2 SCR-02: ゲームプレイ画面

**背景**: 黒

**HUD（上部）**:
- 「Score: N」: 左揃え、x=screenW×0.04、y=screenH×0.055、フォントサイズ screenH×0.038
- 「Lives: N」: 右揃え、x=screenW×0.80、y=screenH×0.055
- 「Stage N / 10」: 中央、y=screenH×0.100

**ポーズボタン（⏸）**:
- 位置: x範囲 screenW×[0.83, 0.98]、y範囲 screenH×[0.008, 0.065]
- 背景色: `argb(180, 35, 35, 60)` (半透明紺)
- 角丸 10f
- WAITING / PLAYING 状態のみ表示

**ゲームオブジェクト**:
- ブロック: 行ごとに色分け（行0:赤、行1:橙、行2:黄、行3:緑、行4:青）、角丸 10f
- パドル: 水色 `rgb(100,200,255)`、角丸（高さ/2）
- ボール: 白い円

**WAITING状態オーバーレイ**:
- 初回: 「Drag paddle · Tap to start」
- ライフロスト後: 「Tap to continue (Lives: N)」
- フォントサイズ screenH × 0.045、y=screenH×0.62

**操作**:
- タッチドラッグ: パドルを指のX座標中央に移動
- ドラッグ/タップ(WAITING中): PLAYING状態に遷移、BGM再開
- ⏸タップ: PAUSED状態に遷移、BGM停止

---

### 6.3 SCR-03: ポーズ画面

**オーバーレイ**: 半透明黒 `argb(190,0,0,0)` で画面全体を覆う

**要素**:
- 「PAUSED」: フォントサイズ screenH×0.075、y=screenH×0.30
- ▶ RESUME ボタン: y範囲 [0.42, 0.505]、背景色 `rgb(30,90,45)` (緑)
- ⚙ DEBUG SETTINGS ボタン: y範囲 [0.535, 0.620]、背景色 `rgb(35,35,80)` (紺)
- ↩ STAGE SELECT ボタン: y範囲 [0.650, 0.735]、背景色 `rgb(70,28,28)` (赤)
- 全ボタンx範囲: [0.15, 0.85]、角丸 18f

**操作**:
- RESUME: WAITING状態に戻り、BGM再開
- DEBUG SETTINGS: `SettingsActivity` をstartActivity
- STAGE SELECT: `initToSelectScreen()` を呼び出しSCR-01へ

---

### 6.4 SCR-04: ステージクリア画面

**オーバーレイなし（ゲームオブジェクトの上にテキストを重ねる）**:
- 「STAGE N」: フォントサイズ screenH×0.07、y=screenH×0.44
- 「CLEAR!」: フォントサイズ screenH×0.06、y=screenH×0.53
- 「Tap for Stage N+1」: フォントサイズ screenH×0.04、y=screenH×0.64

**操作**: 画面タップ → `stage++` して次ステージ開始

---

### 6.5 SCR-05: ゲームオーバー画面

**テキスト**:
- 「GAME OVER」: フォントサイズ screenH×0.08、y=screenH×0.44
- 「Score: N」: フォントサイズ screenH×0.05、y=screenH×0.53
- 「Tap to stage select」: フォントサイズ screenH×0.04、y=screenH×0.64

**操作**: タップ → ステージ選択へ

---

### 6.6 SCR-06: オールクリア画面

**テキスト**:
- 「ALL CLEAR!」: フォントサイズ screenH×0.07、y=screenH×0.44
- 「Score: N」: フォントサイズ screenH×0.05、y=screenH×0.53
- 「Tap to stage select」: フォントサイズ screenH×0.04、y=screenH×0.64

**操作**: タップ → ステージ選択へ

---

### 6.7 SCR-07: デバッグ設定画面 (SettingsActivity)

**テーマ**: 黒背景 (`#111111`)、文字白、SeekBarアクセントカラー `#4C9EE8`

**パラメータ一覧**:

| パラメータ | 表示名 | 最小値 | 最大値 | デフォルト | 説明 |
|---|---|---|---|---|---|
| Ball Speed | Ball Speed | 0.005 | 0.030 | 0.015 | ボール初速（screenWに対する比率） |
| Max Speed Multiplier | Max Speed Multiplier | 1.0 | 8.0 | 4.0 | 最終ブロック到達時の速度倍率 |
| Paddle Width (Stage1) | Paddle Width (Stage 1 %) | 10 | 45 | 28 | ステージ1のパドル幅（screenWの%） |
| Paddle Shrink/Stage | Paddle Shrink / Stage (%) | 0 | 4.0 | 1.6 | ステージ毎のパドル縮小量（screenWの%） |

各パラメータのSeekBar下に日本語説明テキスト（グレー `#888888`、12sp）を表示。

**ボタン**:
- 「デフォルトに戻す」: 全パラメータをデフォルト値にリセット、背景色 `#6B2020`
- 「← 戻る」: finish()、背景色 `#1E2040`

**保存タイミング**: SeekBarのドラッグ終了時 (`onStopTrackingTouch`) および `onStop()`

---

## 7. ゲームルール詳細

### 7.1 スコアリング

1フレームで複数ブロックを同時に破壊した場合は連鎖倍率が適用される:

```
同一フレーム破壊1個目: +10 pt
同一フレーム破壊2個目: +20 pt  (chain=2, 10×2)
同一フレーム破壊3個目: +30 pt  (chain=3, 10×3)
```

### 7.2 ライフシステム

- 初期ライフ: 3
- ボールが画面下端（y - radius > screenH）を超えたとき -1
- ライフ > 0: WAITING状態に戻り、ボールをパドル上にリセット
- ライフ = 0: GAME_OVER状態に遷移

### 7.3 ボール速度の加速

ブロックを破壊するたびに速度が上昇する。

```
ratio = (破壊済みブロック数) / (全ブロック数)
newSpeed = baseBallSpeed × (1 + ratio × (cfgMaxSpeedMult - 1))
```

- `ratio` は0.0（開始時）〜1.0（最後のブロック破壊直前）
- `baseBallSpeed = screenW × cfgBallSpeed`
- 速度変化時は speedX / speedY を等比スケーリング

### 7.4 ピッチレート（SE音程）

ブロック破壊進捗に応じてSE再生ピッチが上がる:

```
currentPitchRate = 1.0 + ratio × 0.5   (range: 1.0 〜 1.5)
```

### 7.5 パドル幅のステージ変化

```
paddleWidth = screenW × ((cfgPaddleBase - (stage-1) × cfgPaddleShrink) / 100)
最小値: screenW × 0.10 (10%)
```

---

## 8. ゲームオブジェクト仕様

### 8.1 ボール

| プロパティ | 計算式 | 備考 |
|---|---|---|
| 半径 | `screenW × 0.028` | |
| 初期X | `screenW / 2` | 画面中央 |
| 初期Y | `paddle.y - radius - 4` | パドル直上4px |
| 初期speedX | `+baseBallSpeed` | |
| 初期speedY | `-baseBallSpeed` | 上方向 |

### 8.2 パドル

| プロパティ | 計算式 | 備考 |
|---|---|---|
| 幅 | `paddleWidthForStage()` 参照 | |
| 高さ | `max(screenH × 0.018, 25px)` | |
| Y位置 | `screenH × 0.85` | |
| X位置 | 中央初期値、タッチで変更 | 画面外には出ない |

**パドル反射のX方向計算**:
```
ball.speedX = ballSpeed × ((ball.x - paddle.x) / paddle.width × 2 - 1)
// 結果: パドル左端 → -1倍、中央 → 0倍、右端 → +1倍
// ball.speedX の範囲: [-ballSpeed, +ballSpeed]
```

### 8.3 ブロック

| プロパティ | 計算式 | 備考 |
|---|---|---|
| 列数 | 8 | 固定 |
| 行数 | 5 | 固定 |
| マージン | `screenW × 0.015` | |
| 幅 | `(screenW - margin × 9) / 8` | |
| 高さ | `screenH × 0.045` | |
| 上端オフセット | `screenH × 0.15` | |

**行色**:
| 行 | 色 (RGB) |
|---|---|
| 0 (最上行) | (220, 50, 50) 赤 |
| 1 | (220, 140, 50) 橙 |
| 2 | (200, 200, 50) 黄 |
| 3 | (50, 180, 50) 緑 |
| 4 | (50, 150, 220) 青 |

---

## 9. ステージパターン定義

8文字 × 5行の文字列配列。`#` = ブロックあり、`.` = 空白。

| ステージ | パターン名 | ブロック数 |
|---|---|---|
| 1 | プラス | 16 |
| 2 | チェッカーボード | 20 |
| 3 | 交互行 | 24 |
| 4 | ピラミッド（上向き） | 28 |
| 5 | ピラミッド（下向き） | 28 |
| 6 | ダブルフレーム | 30 |
| 7 | 密集交互 | 32 |
| 8 | ほぼ全面 | 36 |
| 9 | ほぼ全面2 | 38 |
| 10 | 全面 | 40 |

```
Stage 1:  "...##...", "...##...", "########", "...##...", "...##..."
Stage 2:  "#.#.#.#.", ".#.#.#.#", "#.#.#.#.", ".#.#.#.#", "#.#.#.#."
Stage 3:  "########", "........", "########", "........", "########"
Stage 4:  "...##...", "..####..", ".######.", "########", "########"
Stage 5:  "########", "########", ".######.", "..####..", "...##..."
Stage 6:  "########", "#.####.#", "#......#", "#.####.#", "########"
Stage 7:  "########", "#.#.#.#.", "########", ".#.#.#.#", "########"
Stage 8:  "########", "########", "##....##", "########", "########"
Stage 9:  "########", "########", "########", "########", "#.####.#"
Stage 10: "########", "########", "########", "########", "########"
```

---

## 10. サウンド仕様

全サウンドはPCM合成（コード生成、外部ファイルなし）。サンプルレート: 44100 Hz、モノラル、16bit。

### 10.1 SE一覧

波形: 正弦波 × 指数減衰 × 5msアタック

| SE ID | 周波数 | 継続時間 | 減衰定数τ | 用途 |
|---|---|---|---|---|
| WALL_HIT | A5 (880 Hz) | 80 ms | 25 ms | 壁反射 |
| PADDLE_HIT | D5 (587.33 Hz) | 120 ms | 40 ms | パドル反射 |
| BLOCK_HIT | A4 (440 Hz) | 200 ms | 70 ms | ブロック破壊 |
| LIFE_LOST | D5→A4→E4 (各200ms) | 600 ms | 100 ms | ライフロスト |
| GAME_OVER | B4→A4→G4→E4→D4 (各300ms) | 1500 ms | 150 ms | ゲームオーバー |
| WIN | D4→E4→G4→A4→B4→D5 (各300ms) | 1800 ms | 120 ms | クリア |

SE再生速度はピッチレート（0.5〜2.0倍）で変化。`SoundPool` で最大同時6ストリーム。

### 10.2 BGM

- 方式: Yo音階（ニ長調五音音階: D4 E4 G4 A4 B4）
- テンポ: 72 BPM、4/4拍子、4小節ループ（約13秒）
- 振幅: 0.35（SEの約半分の音量）
- 減衰定数τ: 800 ms（長めの余韻）
- `AudioTrack` MODE_STATIC で無限ループ

**メロディパターン（16拍）**:
```
拍: D4 .  .  A4  G4 .  E4 .  B4 .  .  .  A4 .  G4 .
    1  2  3  4   5  6  7  8   9 10 11 12  13 14 15 16
```
(`. `= 休符)

---

## 11. 調整可能パラメータ（SharedPreferences）

| キー名 | 型 | デフォルト | 最小 | 最大 |
|---|---|---|---|---|
| `ball_speed` | Float | 0.015 | 0.005 | 0.030 |
| `max_speed_mult` | Float | 4.0 | 1.0 | 8.0 |
| `paddle_base` | Float | 28.0 | 10.0 | 45.0 |
| `paddle_shrink` | Float | 1.6 | 0.0 | 4.0 |

SharedPreferences名: `blockbreaker_settings`

---

## 12. ライフサイクル仕様

| イベント | 処理 |
|---|---|
| `Activity.onPause()` | BGM停止、ゲームスレッド停止 |
| `Activity.onResume()` | 設定再読み込み、ゲームスレッド再開 |
| `Activity.onDestroy()` | SoundManager解放 |
| `SurfaceHolder.surfaceCreated` | ゲームスレッド再開 |
| `SurfaceHolder.surfaceChanged` | 画面サイズ取得、設定読み込み、ステージ選択に遷移 |
| `SurfaceHolder.surfaceDestroyed` | ゲームスレッド停止 |

**注意**: `surfaceChanged`は毎回`initToSelectScreen()`を呼び出すため、SettingsActivityから戻るとゲームがリセットされる（デバッグ機能として許容）。
